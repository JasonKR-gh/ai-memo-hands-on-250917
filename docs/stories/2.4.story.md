# Story 2.4: 노트 수정 및 실시간 저장

## Status

Done

## Story

**As a** 로그인한 사용자,
**I want** 기존 노트를 수정하고 변경사항이 실시간으로 자동 저장되는 기능,
**so that** 노트 내용을 쉽게 업데이트하고 실수로 데이터를 잃지 않을 수 있다.

## Acceptance Criteria

1. 노트 상세 페이지에서 "수정" 버튼을 클릭하면 노트 편집 모드로 전환되어야 한다
2. 편집 모드에서는 제목과 본문을 수정할 수 있어야 한다
3. 편집 중에는 "저장" 버튼이 표시되어야 한다
4. 편집 중에는 "취소" 버튼이 표시되어야 한다
5. 편집 중에는 "삭제" 버튼이 숨겨져야 한다
6. 제목이나 본문을 수정하면 3초 후 자동으로 저장되어야 한다
7. 자동 저장 중에는 "저장 중..." 표시가 나타나야 한다
8. 자동 저장이 완료되면 "저장됨" 표시가 나타나야 한다
9. 수동으로 "저장" 버튼을 클릭하면 즉시 저장되어야 한다
10. "취소" 버튼을 클릭하면 변경사항이 취소되고 읽기 모드로 돌아가야 한다
11. 저장 실패 시 적절한 에러 메시지가 표시되어야 한다
12. 편집 모드는 반응형으로 모바일에서도 잘 작동해야 한다
13. 편집 중에는 브라우저 뒤로가기나 새로고침 시 변경사항 저장을 확인해야 한다
14. 빈 제목으로 저장 시 "제목 없음"으로 자동 설정되어야 한다
15. 수정된 노트는 updated_at 필드가 현재 시간으로 업데이트되어야 한다

## Tasks / Subtasks

- [x] 노트 수정 API 구현 (AC: 6, 7, 8, 9, 11, 14, 15)
  - [x] 노트 수정 Server Action 구현
  - [x] 노트 ID로 기존 노트 업데이트 쿼리 구현
  - [x] 사용자 권한 검증 로직 구현 (RLS 정책 활용)
  - [x] 빈 제목 처리 로직 구현 ("제목 없음" 기본값)
  - [x] updated_at 필드 자동 업데이트
  - [x] 에러 처리 및 적절한 에러 메시지 반환
- [x] 노트 편집 UI 구현 (AC: 1, 2, 3, 4, 5, 12)
  - [x] 노트 상세 컴포넌트에 편집 모드 추가
  - [x] 편집 모드 토글 기능 구현
  - [x] 제목 편집 필드 구현 (input 컴포넌트)
  - [x] 본문 편집 필드 구현 (textarea 컴포넌트)
  - [x] "저장", "취소" 버튼 구현
  - [x] 편집 중 "삭제" 버튼 숨김 처리
  - [x] 반응형 레이아웃 구현
- [x] 실시간 자동 저장 기능 구현 (AC: 6, 7, 8, 13)
  - [x] 3초 디바운스 타이머 구현
  - [x] 자동 저장 상태 표시 ("저장 중...", "저장됨")
  - [x] 브라우저 이벤트 처리 (beforeunload, popstate)
  - [x] 변경사항 감지 로직 구현
  - [x] 저장 상태 관리 (로딩, 성공, 실패)
- [x] 수동 저장 및 취소 기능 구현 (AC: 9, 10)
  - [x] 수동 저장 버튼 클릭 처리
  - [x] 취소 버튼 클릭 처리 (변경사항 되돌리기)
  - [x] 편집 모드에서 읽기 모드로 전환
  - [x] 원본 데이터 복원 로직
- [x] 에러 처리 및 사용자 피드백 (AC: 11)
  - [x] 저장 실패 시 에러 메시지 표시
  - [x] 네트워크 에러 처리
  - [x] 권한 에러 처리
  - [x] 사용자 친화적인 에러 UI

## Dev Notes

### 이전 스토리 인사이트

[Source: Story 2.3 Dev Agent Record]

- ✅ 노트 상세 조회 기능 완료
- ✅ Server Actions 패턴 확립 (getNoteDetail)
- ✅ Drizzle ORM 쿼리 패턴 확립
- ✅ 에러 처리 전략 수립 (404, 403, 500)
- ✅ shadcn/ui 컴포넌트 시스템 활용 경험
- ✅ RLS 정책으로 사용자별 데이터 격리 완료
- ✅ 반응형 디자인 패턴 확립

### 데이터 모델 정보

[Source: docs/architecture.md#2-데이터-모델]

**notes 테이블 구조:**
- id (uuid, primary key)
- user_id (uuid, not null) - 사용자 식별
- title (text, not null, default: '제목 없음')
- content (text)
- created_at (timestamp with timezone)
- updated_at (timestamp with timezone)

**노트 수정 쿼리 패턴:**
```typescript
// lib/notes/queries.ts
export async function updateNote(noteId: string, userId: string, data: { title?: string, content?: string }) {
  const result = await db
    .update(notes)
    .set({ 
      ...data, 
      updated_at: new Date() 
    })
    .where(and(eq(notes.id, noteId), eq(notes.userId, userId)))
    .returning();
  
  return result[0] || null;
}
```

### 서버 액션 패턴

[Source: docs/architecture.md#4-서버-액션]

**기존 saveNote 액션 활용:**
- `saveNote` – 노트 작성/수정 (기존 액션 재사용 가능)
- 새로운 `updateNote` 액션 구현 필요
- 사용자 권한 검증 필수
- 에러 처리 및 적절한 응답 반환

### 보안 요구사항

[Source: docs/architecture.md#3-보안]

- **권한 스코프**: 사용자 ID 스코프로 소유자만 수정 가능
- **RLS 정책**: 이미 설정됨 (Story 2.1에서 완료)
- **서버 전용 키**: Supabase 서비스 롤 키는 서버에서만 사용
- **입력 검증**: 제목과 본문 내용 검증 필요

### 프로젝트 구조

[Source: Story 2.3 File List]

**기존 파일 구조:**
- `lib/db/schema/notes.ts` - 노트 스키마 정의
- `lib/notes/actions.ts` - 노트 관련 Server Actions
- `lib/notes/queries.ts` - 노트 조회 쿼리 함수들
- `components/notes/note-detail.tsx` - 노트 상세 컴포넌트
- `app/notes/[id]/page.tsx` - 노트 상세 조회 페이지

**수정할 파일:**
- `lib/notes/actions.ts` - updateNote Server Action 추가
- `lib/notes/queries.ts` - updateNote 쿼리 함수 추가
- `components/notes/note-detail.tsx` - 편집 모드 기능 추가

### UI 컴포넌트 재사용

[Source: Story 2.3 Dev Notes]

**기존 shadcn/ui 컴포넌트:**
- `components/ui/button.tsx` - 액션 버튼들
- `components/ui/card.tsx` - 노트 상세 컨테이너
- `components/ui/input.tsx` - 제목 편집 필드
- `components/ui/textarea.tsx` - 본문 편집 필드
- `components/ui/loading-spinner.tsx` - 로딩 스피너

**새로 필요한 컴포넌트:**
- `components/ui/alert.tsx` - 에러 메시지 표시 (shadcn/ui에서 설치)
- `components/ui/badge.tsx` - 저장 상태 표시 (shadcn/ui에서 설치)

### 실시간 저장 구현 전략

**디바운스 타이머:**
- 3초 후 자동 저장 실행
- 타이머 리셋 시 이전 타이머 취소
- 컴포넌트 언마운트 시 타이머 정리

**상태 관리:**
- 편집 모드 상태 (isEditing)
- 저장 상태 (saving, saved, error)
- 변경사항 감지 (hasChanges)
- 원본 데이터 백업 (originalData)

**브라우저 이벤트 처리:**
- beforeunload: 페이지 떠날 때 변경사항 확인
- popstate: 브라우저 뒤로가기 시 변경사항 확인

### 반응형 디자인

[Source: Story 2.3 Dev Notes]

**브레이크포인트:**
- 모바일: 320px - 768px
- 태블릿: 768px - 1024px
- 데스크톱: 1024px+

**편집 모드 레이아웃 고려사항:**
- 제목 입력 필드는 모바일에서 터치하기 쉬운 크기
- 본문 텍스트 영역은 화면 크기에 맞게 조정
- 버튼들은 모바일에서 터치하기 쉬운 크기로 배치
- 저장 상태 표시는 작은 배지 형태로 우측 상단에 배치

### Testing

#### 테스트 표준

[Source: docs/architecture.md#6-배포운영]

- 테스트 프레임워크: Jest + React Testing Library
- 테스트 파일 위치: `__tests__/` 또는 컴포넌트 옆에 `.test.tsx`

#### 노트 수정 테스트

- 노트 편집 모드 토글 테스트
- 제목/본문 수정 입력 테스트
- 자동 저장 기능 테스트 (3초 디바운스)
- 수동 저장 버튼 테스트
- 취소 버튼 테스트 (변경사항 되돌리기)
- 저장 상태 표시 테스트 ("저장 중...", "저장됨")
- 에러 처리 테스트 (저장 실패)
- 브라우저 이벤트 처리 테스트 (beforeunload)
- 반응형 레이아웃 테스트
- 빈 제목 처리 테스트 ("제목 없음" 기본값)

## Change Log

| Date       | Version | Description | Author           |
| ---------- | ------- | ----------- | ---------------- |
| 2025-01-27 | 1.0     | 스토리 생성 | Scrum Master Bob |
| 2025-01-27 | 1.1     | 구현 완료   | Dev Agent James  |
| 2025-01-27 | 1.2     | 완료 처리   | Dev Agent James  |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4

### Debug Log References

- 노트 수정 API 구현 완료 (updateNote 쿼리 함수, updateNoteAction Server Action)
- UI 컴포넌트 추가 완료 (Alert, Badge 컴포넌트)
- 노트 상세 컴포넌트 편집 모드 구현 완료
- 실시간 자동 저장 기능 구현 완료 (3초 디바운스, 상태 관리)
- 브라우저 이벤트 처리 구현 완료 (beforeunload, popstate)
- 린팅 경고 수정 완료 (useCallback, unused variables)

### Completion Notes List

1. **노트 수정 API 구현**: 
   - `lib/notes/queries.ts`에 `updateNote` 함수 추가
   - `lib/notes/actions.ts`에 `updateNoteAction` Server Action 추가
   - 사용자 권한 검증 및 빈 제목 처리 로직 구현
   - updated_at 필드 자동 업데이트 구현

2. **UI 컴포넌트 추가**:
   - `components/ui/alert.tsx` - 에러 메시지 표시 컴포넌트 생성
   - `components/ui/badge.tsx` - 저장 상태 표시 컴포넌트 생성
   - shadcn/ui 스타일 가이드 준수

3. **노트 상세 컴포넌트 개선**:
   - `components/notes/note-detail.tsx` - 편집 모드 기능 추가
   - 편집/읽기 모드 토글 기능 구현
   - 제목/본문 편집 필드 구현 (Input, Textarea)
   - 저장/취소 버튼 구현

4. **실시간 자동 저장 기능**:
   - 3초 디바운스 타이머 구현
   - 자동 저장 상태 표시 ("저장 중...", "저장됨", "저장 실패")
   - 변경사항 감지 로직 구현
   - 원본 데이터 백업 및 복원 로직

5. **브라우저 이벤트 처리**:
   - beforeunload: 페이지 떠날 때 변경사항 확인
   - popstate: 브라우저 뒤로가기 시 변경사항 확인
   - 사용자 확인 후 페이지 이동 허용/차단

6. **에러 처리 및 사용자 피드백**:
   - 저장 실패 시 에러 메시지 표시
   - 네트워크 에러, 권한 에러 처리
   - 사용자 친화적인 에러 UI (Alert 컴포넌트)

7. **반응형 디자인**:
   - 모바일, 태블릿, 데스크톱 대응
   - 터치 친화적인 버튼 크기
   - 편집 필드 반응형 레이아웃

### File List

**새로 생성된 파일:**
- `components/ui/alert.tsx` - 에러 메시지 표시 컴포넌트
- `components/ui/badge.tsx` - 저장 상태 표시 컴포넌트

**수정된 파일:**
- `lib/notes/queries.ts` - updateNote 쿼리 함수 추가
- `lib/notes/actions.ts` - updateNoteAction Server Action 추가
- `components/notes/note-detail.tsx` - 편집 모드 기능 추가

## QA Results

*This section will be populated by the QA agent after implementation review*
