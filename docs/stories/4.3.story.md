# Story 4.3: 노트 내용 기반 자동 태그 생성

## Status

Done

## Story

**As a** 사용자,
**I want** 노트 내용을 기반으로 AI가 자동으로 최대 6개까지 관련성 높은 태그를 생성하는 기능,
**so that** 노트를 체계적으로 분류하고 검색하기 쉽게 만들 수 있다.

## Acceptance Criteria

1. 노트 저장 시 자동으로 AI 태그가 생성되어야 한다
2. 태그는 최대 6개까지 생성되어야 한다
3. 태그 생성 시간이 10초 이내에 완료되어야 한다
4. 생성된 태그가 노트 내용과 관련성이 높아야 한다
5. 태그 생성 실패 시 적절한 에러 메시지가 표시되어야 한다
6. 기존 태그가 있는 경우 새로 생성된 태그로 업데이트되어야 한다
7. 태그 생성 중 로딩 상태가 표시되어야 한다
8. 태그는 노트 상세 페이지에서 표시되어야 한다
9. 태그 생성은 서버사이드에서 처리되어야 한다
10. 토큰 제한(8k)을 초과하는 노트는 적절히 처리되어야 한다
11. 생성된 태그는 검색 가능해야 한다
12. 태그는 클릭 가능한 형태로 표시되어야 한다

## Tasks / Subtasks

- [x] 태그 생성 서버 액션 구현 (AC: 1, 6, 9)
  - [x] `generateTags` 서버 액션 생성
  - [x] Gemini API를 통한 태그 생성 로직 구현
  - [x] 기존 태그 업데이트 로직 구현
  - [x] 사용자 권한 검증 추가
- [x] 태그 데이터 모델 및 스키마 확장 (AC: 2, 6)
  - [x] note_tags 테이블 스키마 확인/수정
  - [x] 태그 데이터 타입 정의
  - [x] 태그 생성/업데이트 쿼리 구현
- [x] 프론트엔드 태그 표시 기능 (AC: 4, 8, 12)
  - [x] 노트 상세 페이지에 태그 섹션 추가
  - [x] 태그 표시 컴포넌트 구현
  - [x] 클릭 가능한 태그 스타일링 적용
- [x] 로딩 상태 및 에러 처리 (AC: 3, 5, 7)
  - [x] 태그 생성 중 로딩 인디케이터 표시
  - [x] 에러 상태 처리 및 사용자 피드백
  - [x] 타임아웃 처리 (10초)
- [x] 토큰 제한 처리 (AC: 10)
  - [x] 노트 내용 길이 검증
  - [x] 긴 노트의 경우 적절한 처리 로직
  - [x] 토큰 계산 유틸리티 활용
- [x] 검색 기능 통합 (AC: 11)
  - [x] 태그 기반 검색 쿼리 구현
  - [x] 검색 결과에 태그 매칭 표시
- [x] 테스트 구현 (AC: 1-12)
  - [x] 태그 생성 서버 액션 테스트
  - [x] 프론트엔드 컴포넌트 테스트
  - [x] 에러 케이스 테스트
  - [x] 통합 테스트

## Dev Notes

### Previous Story Insights
- 스토리 4.1에서 Gemini API 클라이언트와 기본 설정이 완료됨
- 스토리 4.2에서 요약 생성 기능이 완료되어 동일한 패턴 적용 가능
- `lib/ai/gemini-client.ts`에서 GeminiClient 클래스 사용 가능
- `lib/ai/types.ts`에 AI 서비스 관련 타입 정의 완료
- `lib/ai/actions.ts`에 서버 액션 구조 설정됨

### Data Models
- **note_tags 테이블** (기존 스키마):
  - note_id: UUID (notes 테이블 참조)
  - tag: string (태그명)
  - created_at: timestamp
- **태그 데이터 타입**:
  ```typescript
  interface TagData {
    noteId: string;
    tag: string;
    createdAt: Date;
  }
  ```

### API Specifications
- **Gemini API 호출**:
  - 모델: gemini-1.5-flash
  - 프롬프트: "다음 노트 내용을 분석하여 최대 6개의 관련성 높은 태그를 생성해주세요. 태그는 쉼표로 구분하여 한 줄로 출력해주세요."
  - 토큰 제한: 8,000 토큰
  - 응답 형식: 쉼표로 구분된 태그 문자열

### Component Specifications
- **태그 표시 컴포넌트**:
  - 위치: `components/notes/note-detail.tsx`에 통합
  - 스타일: shadcn/ui Badge 컴포넌트 사용
  - 클릭 가능: 태그 클릭 시 해당 태그로 검색
  - 로딩 상태: LoadingSpinner 컴포넌트 사용

### File Locations
- **서버 액션**: `lib/ai/actions.ts`에 `generateTags` 함수 추가
- **데이터베이스 쿼리**: `lib/notes/queries.ts`에 태그 관련 쿼리 추가
- **타입 정의**: `lib/ai/types.ts`에 태그 관련 타입 추가
- **컴포넌트**: `components/notes/note-detail.tsx` 수정
- **테스트**: `__tests__/ai/tag-generation.test.ts` 생성

### Testing Requirements
- **테스트 파일 위치**: `__tests__/ai/` 디렉토리
- **테스트 프레임워크**: Vitest 사용
- **테스트 범위**:
  - 서버 액션 단위 테스트
  - 컴포넌트 렌더링 테스트
  - 에러 케이스 테스트
  - 통합 테스트 (API 호출 포함)
- **모킹**: Gemini API 호출 모킹 필요

### Technical Constraints
- **토큰 제한**: 8,000 토큰 (Gemini 무료 할당)
- **응답 시간**: 10초 이내
- **보안**: 서버사이드에서만 AI API 호출
- **에러 처리**: 네트워크 오류, API 제한, 토큰 초과 등 모든 케이스 처리
- **태그 제한**: 최대 6개 태그 생성

## Testing

### Test Standards
- **테스트 파일 위치**: `__tests__/ai/tag-generation.test.ts`
- **테스트 프레임워크**: Vitest
- **테스트 패턴**: 
  - Given-When-Then 구조
  - 각 AC별 테스트 케이스 작성
  - 모킹을 통한 외부 의존성 격리
- **테스트 커버리지**: 90% 이상 목표

### Specific Testing Requirements
- 태그 생성 성공 케이스
- 에러 처리 케이스 (API 실패, 타임아웃, 토큰 초과)
- 로딩 상태 표시 테스트
- 기존 태그 업데이트 테스트
- 권한 검증 테스트
- 태그 검색 기능 테스트

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | 초기 스토리 생성 | SM Agent |
| 2024-12-19 | 1.1 | 스토리 구현 완료 및 모든 기능 테스트 통과 | Dev Agent |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (Anthropic)

### Debug Log References
- 모든 구현 과정에서 린트 에러 없이 완료됨
- 테스트 실행 시 19개 테스트 모두 통과 (100% 성공률)
- 데이터베이스 마이그레이션 파일 생성 완료

### Completion Notes List
- note_tags 테이블 스키마 생성 및 마이그레이션 파일 생성 완료
- 태그 생성/조회 서버 액션 구현 완료 (토큰 제한, 권한 검증 포함)
- 노트 상세 페이지에 AI 태그 섹션 통합 완료
- 로딩 상태, 에러 처리, 재생성 기능 모두 구현 완료
- 포괄적인 테스트 스위트 작성 및 실행 완료 (19개 테스트 케이스)
- 태그 기반 검색 기능 구현 완료
- 모든 Acceptance Criteria 충족 확인 완료

### File List
**새로 생성된 파일:**
- `lib/db/schema/note-tags.ts` - 태그 데이터 모델 스키마
- `__tests__/ai/tag-generation.test.ts` - 태그 생성 기능 테스트
- `drizzle/0004_futuristic_blackheart.sql` - note_tags 테이블 마이그레이션

**수정된 파일:**
- `lib/db/schema/index.ts` - note-tags 스키마 export 추가
- `lib/ai/types.ts` - 태그 관련 타입 정의 추가
- `lib/ai/actions.ts` - 태그 생성/조회 서버 액션 추가
- `lib/notes/queries.ts` - 태그 관련 데이터베이스 쿼리 추가
- `components/notes/note-detail.tsx` - AI 태그 섹션 통합

## QA Results

TBD
